<p>Концептуально отделяем кнопку (как элемент интерфейса) от действия (вызываемой операции). Действие может быть привязано к нескольким кнопкам. Действие может быть привязано вообще не к кнопке. Под действием будем понимать совокупность выполняемых операций на клиенте и сервере, объединенных общей задачей.</p>
<p>Сознательно идем на следующие ограничения</p>
<ol>
<li>
<p>к компоненту (кнопке) не должно быть привязано несколько действий. Это позволяет оставить за пределами рассмотрения сценарии: как рассчитывать доступность, как передавать данные от одного действия к другому и тд</p>
</li>
<li>
<p>в рамках действия может происходить несколько обменов с сервером, но все они происходят в рамках одной группы API</p>
</li>
</ol>
<h3 id="клиентская-часть.">Клиентская часть.</h3>
<p>Учитывая текущий опыт переиспользования интерфейсов, большая вероятность что последующие проекты, построенные на платформе будут реализовывать собственный слой представления UI поверх протоколов (API) бэка. В связи с этим видится максимально неспецифичное описание клиентского действия. Предполагаю наличие следующих атрибутов действия:</p>
<ul>
<li>
<p>код действий. Может быть задан в виде иерархии, когда требуется однотипно обработать действия одного вида, например lc/sendDocument, где lc - группа, sendDocument - конкретное действие. Простые действия могут не использовать группы, могут использовать какой-то стандартный набор групп, например sign/sign, sign/verify - действия по проверке подписей, либо stdactions/sign, stdactions/singVerify, либо sign, signVerify. Пока не вижу доводов в пользу того или иного подхода, детали реализации. Код действия так же может включать версию реализации этого действия, например, v1/lc/sendDocument, v2/sign. Такой подход позволит постепенно изменять поведение действий.</p>
</li>
<li>
<p>описание действия. полезно для вывода в качестве текста кнопки или всплывающей подсказки</p>
</li>
<li>
<p>клиентские параметры действия. Параметры, которые будут переданы вместе с описанием кнопки на фронт</p>
</li>
<li>
<p>серверные параметры действия. Параметры, которые не передаются на фронт и используются в момент исполнения действия на бэке</p>
</li>
<li>
<p>валидаторы - контроллеры доступности кнопок. Указывается список клиентских/серверных контроллеров доступности кнопки</p>
</li>
</ul>
<p>На клиентской стороне для каждого действия/группы действий реализован обработчик. В задачи обработчика входит:</p>
<ul>
<li>
<p>организовать диалог с пользователем, если необходимо. В т.ч. формы ввода значений могут быть заданы параметром клиентского действия. В этом случае клиент осуществляет загрузку дескриптора формы, указанного в параметрах с бэка и отображение пользователю.</p>
</li>
<li>
<p>организовать вызов бэкенда (опционально). Клиентский код действия подготавливает данные (об этом ниже) для отправки на бэк в соответствии с заложенным в это действие алгоритмом и осуществляет один или несколько вызовов бэка. При этом URL для обращения к бэкенду всегда формируются по следующему алгоритму строго в следующем порядке:</p>
</li>
<li>
<p>стандартный префикс /api/actions/</p>
</li>
<li>
<p>идентификатор действия</p>
</li>
<li>
<p>спец-символ ($ или @) + опциональные компоненты пути, определяемые постановкой на реализацию обработчика</p>
</li>
<li>
<p>отображение результатов. После завершения всех действий клиентский код отрисовывает результат выполнения операции в соответствии с постановкой на конкретную операцию</p>
</li>
<li>
<p>повторный вызов. В случае ошибки выполнения операции на бэке клиент должен либо предоставить пользователю возможность повторить выполнение операции, либо осуществить повторную обработку самостоятельно. В любом сценарии состав отправленных на сервер данных в случае повторной отправки должен быть идентичен составу при первичной отправке. Другими словами, осуществляя вызов бэкенда клиент сохраняет все данные запроса до момента успешного завершения вызова. Если в рамках операции осуществлялось несколько раундов взаимодействия с сервером, то все они должны быть выполнены повторно в том порядке, в котором запускались изначально <em><strong>(тут спорно, нужно понять сценарии. В большинстве случаев выглядит так, что нужно повторять только последнее действие)</strong></em></p>
</li>
</ul>
<p>Протокол взаимодействия:</p>
<ol>
<li>Заголовки. Клиент осуществляет передачу следующих заголовков на бэк, для каждого из вызовов, осуществляемых в ходе исполнения операции:</li>
</ol>
<ul>
<li>
<p>X_PID(processInstanceId). Уникальный идентификатор процесса. Должен быть сформирован один раз на каждое выполняемое действие. Если в рамках обработчика выполняется несколько вызовов бэка, то все вызовы происходят с одним и тем же processInstanceId. Если операция выполняется повторно, то она выполняется с тем же processInstanceId</p>
</li>
<li>
<p>X_ORG/X_USER(userOrg/userId). Идентификатор организации, пользователя. Возможно, эти данные необходимо получать из сессии СБ на портале</p>
</li>
<li>
<p>X_START_TIME (startTime). Время начала выполнения операции (т.е. момент нажатия пользователем на кнопку). Должно выставляться для каждого вызова бэка. Всегда используется текущее время клиента в формате UTC. Генерируется в начале выполнения действия и передается со всеми запросами на сервер в рамках одного действия без изменения.</p>
</li>
<li>
<p>X_REQUEST_START_TIME. Время начала выполнения запроса на сервер. Всегда используется текущее время клиента в формате UTC. В случае повторных вызовов рассчитывается заново.</p>
</li>
<li>
<p>X_DOC_TYPE (вид документа). Код вида документа, над которым производится действие</p>
</li>
<li>
<p>X_LOCATION (местонахождение в системе). Пункт меню в дереве навигации (идентификатор)</p>
</li>
<li>
<p>X_CLIENT_ID. Идентификатор клиента. Генерируется один раз и сохраняется в local storage. Не меняется от вызова к вызову</p>
</li>
<li>
<p>X_REQUEST_ID. Идентификатор конкретного вызова. Генерируется каждый раз заново перед каждым вызовом сервера. <strong>В случае ретрая должен быть сгенерирован заново</strong></p>
</li>
<li>
<p>Уточнить у Максима про opentracing. Возможно нам нужны traceid/spanid</p>
</li>
</ul>
<ol start="3">
<li>
<p>Данные (payload). Данные всегда передаются в виде объекта при помощи метода POST.</p>
</li>
<li>
<p>Файлы</p>
</li>
</ol>
<h3 id="примерный-агоритм-работы-клиента">Примерный агоритм работы клиента</h3>
<ol>
<li>
<p>Пользователь нажимает на кнопку “Передать на исполнение”. К кнопке привязано действие v1/lc/to-execution</p>
</li>
<li>
<p>Фронт разбивает идентификатор действия на группы, подбирая готовое действие среди библиотеки доступных действий js-кода (часть кода фронта). Поиск обработчика действия осуществляется от наиболее конкретного к наиболее общему. В данном примере вначале ищется обработчик, для v1/lc/to-execution, затем обработчик v1/lc, затем v1. В данном примере предполагаем что на бэке есть обработчик группы действий v1/lc</p>
</li>
<li>
<p>Фронт запрашивает данные у пользователя (если это определено алгоритмом работы действия)</p>
</li>
<li>
<p>Фронт готовит данные для вызова бэка. В т.ч. формирует и сохраняет необходимые заголовки и тело пакета. Фронт также формирует URI для обращения на сервер. В данном пример /api/actions/v1/lc/to-execution</p>
</li>
<li>
<p>Фронт осуществляет вызов сервер и ожидание ответа. Если в результате выполнения операции фронт получает ошибки:</p>
</li>
</ol>
<ul>
<li>
<p>500, 502, 503, 504, 429, 408 то осуществляется попытка повторного вызова</p>
</li>
<li>
<p>400 - сообщаем об ошибке пользователю. Предлагаем сформировать обращение в службу поддержки. При этом обязательно осуществляем передачу заголовков с которыми был сформирован запрос и URI на который запрос отправлялся</p>
</li>
<li>
<p>403 - сообщаем, что у пользователя нет прав на выполнение операции</p>
</li>
<li>
<p>410 - сообщаем, что такая операция не найдена. Предлагаем обратиться в службу поддержки. При этом обязательно осуществляем передачу заголовков с которыми был сформирован запрос и URI на который запрос отправлялся</p>
</li>
</ul>
<h1 id="серверная-часть">Серверная часть</h1>
<h2 id="gateway">Gateway</h2>
<p>Задачи gateway:</p>
<ul>
<li>
<p>провалидировать доступ пользователя к действию:</p>
</li>
<li>
<p>gateway определяет что пользователь запросил выполнение действия ( запрос пришел на /api/actions/</p>
</li>
<li>
<p>определяет идентификатор действия. Для этого:</p>
</li>
<li>
<p>из URI удаляется /api/actions/</p>
</li>
<li>
<p>берется подстрока между началом строки и символом ? (параметры запроса)</p>
</li>
<li>
<p>берется подстрока между началом строки и спец-символом (@ или $)</p>
</li>
<li>
<p>по полученному идентификатору действия обращается в ПОИБ с целью проверки доступности действия пользователю (есть смысл кешировать на непродолжительное время)</p>
</li>
<li>
<p>определить целевой сервер</p>
</li>
<li>
<p>тут, возможно, есть смысл заложить категорию действий, которые нецелесообразно передавать на бэк и можно выполнить на GW. В качестве варианта можно заложиться на то, что идентификатор действия имеет группу gw/. Примером такого действия может быть проверка наличия вложения или получение информации об организации и тд. нужно сказать, что этот пункт исключение из правил. В целом, возлагать задачу определения бэкенд сервера на URL неправильно, т.к. это дырявая абстракция и знание о внутреннем устройстве системы утекает наружу.</p>
</li>
<li>
<p>В качестве альтернативы предыдущему способу можно рассмотреть создание более конкретного URL-мэпинга для каких-то действий. Например, есть общий мэпинг на /api/actions, который действует по алгоритму изложенному в следующих пунктах. А есть мэпинг на /api/actions/some-func-action, который, очевидно, будет иметь приоритет над первым.</p>
</li>
<li>
<p>по заголовку X_DOC_TYPE восстанавливается вид документа. Либо по заголовку X_LOCATION.</p>
</li>
<li>
<p>по виду документа определяется целевой сервер на который отправить запрос.</p>
</li>
<li>
<p>отправить запрос. На целевой сервер отправляется запрос выполнения действия. Используем grpc. Payload пересылаем в виде строки, файлы как массив байт  (тут сразу вопрос к размеру файлов, либо закладываться на стриминг grpc). В ответ сервер присылает массив байт и кодировку ответа, либо код ошибки. Ошибка транслируется в HTTP-ошибку. Массив байт отдается в качестве ответа:</p>
</li>
<li>
<p>ошибка отсутствия действия в 410 ошибку</p>
</li>
<li>
<p>ошибка таймаутов в 408</p>
</li>
<li>
<p>ошибка отсутсвия доступа к действию в 403</p>
</li>
<li>
<p>ошибка отсутствия данных о пользователи в 401</p>
</li>
<li>
<p>остальные в 500</p>
</li>
</ul>
<h2 id="целевой-сервер">Целевой сервер</h2>
<p>Целевой сервер получает запрос на выполнение операции через GRPC. В запросе идут все данные переданные клиентом (grpc streaming?). Далее сервер подбирает бин, реализующий определенный интерфейс и имеющий идентификатор == идентификатору действия. Т.к. идентификатор действий иерархический, то: вначале подбираем наиболее конкретный бин, далее менее конкретный и т.д. Отброшенные компоненты пути передаются найденному обработчику. Если обработчик не найден возвращаем ошибку. Если найден - вызываем его, передавая всю полученную информацию. Тут важно придти к контракту метода максимально похожему на написание REST-контроллеров. Это позволит в дальнейшем (если потребуется) перейти на REST взаимодействие в обход grpc. Т.е. видится так, что нужно обрабатывать мэпинги @Controller, @RequestMapping, обрабатывать аннотации @PathVariable, @RequestBody и др.</p>
<p>Открытый вопрос, нужно ли на целевом сервере проводить повторный контроль допустимости исполнения операции. Мне видится что нет.  Решить вопрос с ИБ</p>
<p>Целевой сервер формирует ответ на попытку выдать действие. Информация, которая может быть включена в ответ видится следующей:</p>
<ul>
<li>
<p>допустимость выполнения действия: Допустимо, Отклонено валидатором, Отклонено компонентом ИБ.</p>
</li>
<li>
<p>признак наличия ошибки, в т.ч. с классификатором ошибки (допускает повторное выполнение/не допускает) и кодом ошибки для передачи в службу поддержки</p>
</li>
<li>
<p>формат результата: сообщение, данные (payload), файл, коллекция файлов, информация об отложенном исполнении (т.е. результат появится позже)</p>
</li>
<li>
<p>содержимое результата (определяется форматом результата)</p>
</li>
</ul>
<h2 id="валидаторы">Валидаторы</h2>
<p>Валидаторы или контроллеры доступности кнопок определяют когда кнопки необходимо отключить. По умолчанию считаем что все кнопки доступны. Валидаторы не проверяют политики безопасности и делятся на несколько групп: клиентские (рассчитываются на клиенте), смешанные (клиентские и серверные), серверные. Примеры валидаторов:</p>
<ul>
<li>
<p>selection/selected - отключает кнопку, если нет выбранных документов. Данную проверку не возможно выполнить на бэке, т.к. бэк не хранит репрезентативное состояние (т.е. не знает что отображено клиенту). Это клиентский валидатор</p>
</li>
<li>
<p>condition/fields - проверяет условия для полей документа. Может быть выполнено как на фронте, так и на gateway. Тут важно заложить какой-то минимальный формат условия, парсинг которого будет лекго реализовать и на фронте и на бэке (json-path ?)</p>
</li>
<li>
<p>condition/user/has_role - проверяет условие наличие роли у пользователя. Выполнять такое на фронте не имеет смысла, т.к. мы обязаны будем перепроверить данные на бэке.</p>
</li>
</ul>
<p>В целом видится, что нужно сформировать минимальную библиотеку валидаторов исходя из текущих потребностей и прорабатывать ее отдельно.</p>
<h2 id="алгоритм-взаимодействия-клиент-и-бэка-в-части-работы-с-мета-описанием-действий">Алгоритм взаимодействия клиент и бэка в части работы с мета-описанием действий</h2>
<ol>
<li>Бэк обращается к фронту для получения списка действий для разных меню визуальной формы. Бэк читает .menu и формирует ответ фронту, внося следующие корректировки:</li>
</ol>
<ul>
<li>
<p>у СБ запрашивается список доступных действий над документом для конкретного субъекта и запрещенные действия отмечаются как “Запрещено к выполнению”. Действие при этом не исключается из списка, передается на фронт. На фронте элементы управления, к которым привязаны такие действия должны быть недоступны для взаимодействия, всплывающая подсказка должна уточнять причину недоступности - “Запрещено политикой безопасности”. Запрошенные политики имеет смысл кешировать на непродолжительное время (пару минут)</p>
</li>
<li>
<p>Для действия выполняются серверные и клиент-серверные валидаторы, имеющие смысл на данном этапе. Например, проверить что пользователь входит в какую-то роль можно на этом этапе. А вот убедиться что поле документа имеет определенное значение нельзя, т.к. никакого документа еще не загружено. Как вариант, такие классы валидаторов отмечать специальным интерфейсом на бэке. Отключенные действия также пересылаются на клиента с пометкой “отключено условием”.</p>
</li>
<li>
<p>список действий пересылается на клиента, в т.ч. к действиям добавляется описание клиентских и клиент-серверных валидаторов</p>
</li>
<li>
<p>фронт, получив список действий вычисляет условия, которые возможно вычислить на данном этапе</p>
</li>
</ul>
<h3 id="жц-валидатора.">ЖЦ Валидатора.</h3>
<p>На фронте будет лежать ответственность за периодический вызов валидаторов во время работы пользователя с системой. Часть валидаторов (проверка выбран ли документ, выбрана ли строка таблицы) обсчитывается когда пользователь выполняет действия в определенной области (таблице), часть валидаторов (проверка условия по полям) обсчитывается когда пользователь или система изменяет поле на форме и т.д.<br>
<strong>Важный момент</strong> непонятно, нужно ли обсчитывать серверные валидаторы в процессе работы клиента с формой (возможно, достаточно их обсчитать при вызове действия). Однако, если такой сценарий будет востребован, то в обязательном порядке необходимо сделать пакетную обработку - т.е. фронт обращается к беку с просьбой рассчитать доступность ВСЕХ кнопок для такого-то контекста (документа, папки).</p>
<h2 id="диаграмма-получения-доступных-действий-клиентом">Диаграмма получения доступных действий клиентом</h2>
<pre class=" language-mermaid"><svg id="mermaid-svg-Tk67ihfEHjLXWnKO" width="100%" xmlns="http://www.w3.org/2000/svg" height="593" style="max-width: 2426px;" viewBox="-50 -10 2426 593"><style>#mermaid-svg-Tk67ihfEHjLXWnKO{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#000000;}#mermaid-svg-Tk67ihfEHjLXWnKO .error-icon{fill:#552222;}#mermaid-svg-Tk67ihfEHjLXWnKO .error-text{fill:#552222;stroke:#552222;}#mermaid-svg-Tk67ihfEHjLXWnKO .edge-thickness-normal{stroke-width:2px;}#mermaid-svg-Tk67ihfEHjLXWnKO .edge-thickness-thick{stroke-width:3.5px;}#mermaid-svg-Tk67ihfEHjLXWnKO .edge-pattern-solid{stroke-dasharray:0;}#mermaid-svg-Tk67ihfEHjLXWnKO .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-svg-Tk67ihfEHjLXWnKO .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-svg-Tk67ihfEHjLXWnKO .marker{fill:#666;stroke:#666;}#mermaid-svg-Tk67ihfEHjLXWnKO .marker.cross{stroke:#666;}#mermaid-svg-Tk67ihfEHjLXWnKO svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-svg-Tk67ihfEHjLXWnKO .actor{stroke:hsl(0,0%,83%);fill:#eee;}#mermaid-svg-Tk67ihfEHjLXWnKO text.actor > tspan{fill:#333;stroke:none;}#mermaid-svg-Tk67ihfEHjLXWnKO .actor-line{stroke:#666;}#mermaid-svg-Tk67ihfEHjLXWnKO .messageLine0{stroke-width:1.5;stroke-dasharray:none;stroke:#333;}#mermaid-svg-Tk67ihfEHjLXWnKO .messageLine1{stroke-width:1.5;stroke-dasharray:2,2;stroke:#333;}#mermaid-svg-Tk67ihfEHjLXWnKO #arrowhead path{fill:#333;stroke:#333;}#mermaid-svg-Tk67ihfEHjLXWnKO .sequenceNumber{fill:white;}#mermaid-svg-Tk67ihfEHjLXWnKO #sequencenumber{fill:#333;}#mermaid-svg-Tk67ihfEHjLXWnKO #crosshead path{fill:#333;stroke:#333;}#mermaid-svg-Tk67ihfEHjLXWnKO .messageText{fill:#333;stroke:#333;}#mermaid-svg-Tk67ihfEHjLXWnKO .labelBox{stroke:hsl(0,0%,83%);fill:#eee;}#mermaid-svg-Tk67ihfEHjLXWnKO .labelText,#mermaid-svg-Tk67ihfEHjLXWnKO .labelText > tspan{fill:#333;stroke:none;}#mermaid-svg-Tk67ihfEHjLXWnKO .loopText,#mermaid-svg-Tk67ihfEHjLXWnKO .loopText > tspan{fill:#333;stroke:none;}#mermaid-svg-Tk67ihfEHjLXWnKO .loopLine{stroke-width:2px;stroke-dasharray:2,2;stroke:hsl(0,0%,83%);fill:hsl(0,0%,83%);}#mermaid-svg-Tk67ihfEHjLXWnKO .note{stroke:hsl(60,100%,23.3333333333%);fill:#ffa;}#mermaid-svg-Tk67ihfEHjLXWnKO .noteText,#mermaid-svg-Tk67ihfEHjLXWnKO .noteText > tspan{fill:#333;stroke:none;}#mermaid-svg-Tk67ihfEHjLXWnKO .activation0{fill:#f4f4f4;stroke:#666;}#mermaid-svg-Tk67ihfEHjLXWnKO .activation1{fill:#f4f4f4;stroke:#666;}#mermaid-svg-Tk67ihfEHjLXWnKO .activation2{fill:#f4f4f4;stroke:#666;}#mermaid-svg-Tk67ihfEHjLXWnKO:root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}#mermaid-svg-Tk67ihfEHjLXWnKO sequence{fill:apa;}</style><g></g><g><line id="actor6904" x1="75" y1="5" x2="75" y2="582" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="0" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="75" y="32.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="75" dy="0">User</tspan></text></g><g><line id="actor6905" x1="434" y1="5" x2="434" y2="582" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="359" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="434" y="32.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="434" dy="0">WebClient</tspan></text></g><g><line id="actor6906" x1="1252" y1="5" x2="1252" y2="582" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="1177" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="1252" y="32.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="1252" dy="0">Gateway</tspan></text></g><g><line id="actor6907" x1="1843" y1="5" x2="1843" y2="582" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="1768" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="1843" y="32.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="1843" dy="0">| Metadata</tspan></text></g><g><line id="actor6908" x1="2043" y1="5" x2="2043" y2="582" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="1968" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="2043" y="32.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="2043" dy="0">SecurityGate</tspan></text></g><g><line id="actor6909" x1="2247" y1="5" x2="2247" y2="582" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="2168" y="0" fill="#eaeaea" stroke="#666" width="158" height="65" rx="3" ry="3" class="actor"></rect><text x="2247" y="32.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="2247" dy="0">ActionValidationService</tspan></text></g><defs><marker id="arrowhead" refX="9" refY="5" markerUnits="userSpaceOnUse" markerWidth="12" markerHeight="12" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z"></path></marker></defs><defs><marker id="crosshead" markerWidth="15" markerHeight="8" orient="auto" refX="16" refY="4"><path fill="black" stroke="#000000" stroke-width="1px" d="M 9,2 V 6 L16,4 Z" style="stroke-dasharray: 0px, 0px;"></path><path fill="none" stroke="#000000" stroke-width="1px" d="M 0,1 L 6,7 M 6,1 L 0,7" style="stroke-dasharray: 0px, 0px;"></path></marker></defs><defs><marker id="filled-head" refX="18" refY="7" markerWidth="20" markerHeight="28" orient="auto"><path d="M 18,7 L9,13 L14,7 L9,1 Z"></path></marker></defs><defs><marker id="sequencenumber" refX="15" refY="15" markerWidth="60" markerHeight="40" orient="auto"><circle cx="15" cy="15" r="6"></circle></marker></defs><text x="255" y="80" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family: &quot;trebuchet ms&quot;, verdana, arial, sans-serif; font-size: 16px; font-weight: 400;">Открыть спиочную форму документа А</text><line x1="75" y1="113" x2="434" y2="113" class="messageLine0" stroke-width="2" stroke="none" marker-end="url(#arrowhead)" style="fill: none;"></line><text x="843" y="128" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family: &quot;trebuchet ms&quot;, verdana, arial, sans-serif; font-size: 16px; font-weight: 400;">Запрос метаданных документа А</text><line x1="434" y1="161" x2="1252" y2="161" class="messageLine0" stroke-width="2" stroke="none" marker-end="url(#arrowhead)" style="fill: none;"></line><text x="1548" y="176" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family: &quot;trebuchet ms&quot;, verdana, arial, sans-serif; font-size: 16px; font-weight: 400;">Прочитать метаданные документа</text><line x1="1252" y1="209" x2="1843" y2="209" class="messageLine0" stroke-width="2" stroke="none" style="fill: none;"></line><text x="1648" y="224" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family: &quot;trebuchet ms&quot;, verdana, arial, sans-serif; font-size: 16px; font-weight: 400;">Запросить доступные действия для пользователя</text><line x1="1252" y1="257" x2="2043" y2="257" class="messageLine0" stroke-width="2" stroke="none" marker-end="url(#arrowhead)" style="fill: none;"></line><text x="1648" y="272" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family: &quot;trebuchet ms&quot;, verdana, arial, sans-serif; font-size: 16px; font-weight: 400;">Вернуть список разрешенных действий</text><line x1="2043" y1="305" x2="1252" y2="305" class="messageLine0" stroke-width="2" stroke="none" marker-end="url(#arrowhead)" style="fill: none;"></line><text x="1548" y="320" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family: &quot;trebuchet ms&quot;, verdana, arial, sans-serif; font-size: 16px; font-weight: 400;">В список действий поместить информацию о запрещенных действиях</text><line x1="1252" y1="353" x2="1843" y2="353" class="messageLine0" stroke-width="2" stroke="none" style="fill: none;"></line><text x="1750" y="368" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family: &quot;trebuchet ms&quot;, verdana, arial, sans-serif; font-size: 16px; font-weight: 400;">Выполнить валидаторы, срабатывающие на серверной стороне</text><line x1="1252" y1="401" x2="2247" y2="401" class="messageLine0" stroke-width="2" stroke="none" style="fill: none;"></line><text x="843" y="416" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family: &quot;trebuchet ms&quot;, verdana, arial, sans-serif; font-size: 16px; font-weight: 400;">вернуть метаинформацию о действиях,в  т.ч. причину отключения. Вернуть клиентские валидаторы</text><line x1="1252" y1="449" x2="434" y2="449" class="messageLine0" stroke-width="2" stroke="none" marker-end="url(#arrowhead)" style="fill: none;"></line><text x="255" y="464" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family: &quot;trebuchet ms&quot;, verdana, arial, sans-serif; font-size: 16px; font-weight: 400;">Отрисованное меню</text><line x1="434" y1="497" x2="75" y2="497" class="messageLine0" stroke-width="2" stroke="none" marker-end="url(#arrowhead)" style="fill: none;"></line><g><rect x="0" y="517" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="75" y="549.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="75" dy="0">User</tspan></text></g><g><rect x="359" y="517" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="434" y="549.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="434" dy="0">WebClient</tspan></text></g><g><rect x="1177" y="517" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="1252" y="549.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="1252" dy="0">Gateway</tspan></text></g><g><rect x="1768" y="517" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="1843" y="549.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="1843" dy="0">| Metadata</tspan></text></g><g><rect x="1968" y="517" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="2043" y="549.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="2043" dy="0">SecurityGate</tspan></text></g><g><rect x="2168" y="517" fill="#eaeaea" stroke="#666" width="158" height="65" rx="3" ry="3" class="actor"></rect><text x="2247" y="549.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="2247" dy="0">ActionValidationService</tspan></text></g></svg></pre>
<h2 id="диаграмма-обновления-доступности-кнопок-на-клиенте">Диаграмма обновления доступности кнопок на клиенте</h2>
<pre class=" language-mermaid"><svg id="mermaid-svg-9kPj39AY4a0dpYlk" width="100%" xmlns="http://www.w3.org/2000/svg" height="401" style="max-width: 1781px;" viewBox="-50 -10 1781 401"><style>#mermaid-svg-9kPj39AY4a0dpYlk{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#000000;}#mermaid-svg-9kPj39AY4a0dpYlk .error-icon{fill:#552222;}#mermaid-svg-9kPj39AY4a0dpYlk .error-text{fill:#552222;stroke:#552222;}#mermaid-svg-9kPj39AY4a0dpYlk .edge-thickness-normal{stroke-width:2px;}#mermaid-svg-9kPj39AY4a0dpYlk .edge-thickness-thick{stroke-width:3.5px;}#mermaid-svg-9kPj39AY4a0dpYlk .edge-pattern-solid{stroke-dasharray:0;}#mermaid-svg-9kPj39AY4a0dpYlk .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-svg-9kPj39AY4a0dpYlk .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-svg-9kPj39AY4a0dpYlk .marker{fill:#666;stroke:#666;}#mermaid-svg-9kPj39AY4a0dpYlk .marker.cross{stroke:#666;}#mermaid-svg-9kPj39AY4a0dpYlk svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-svg-9kPj39AY4a0dpYlk .actor{stroke:hsl(0,0%,83%);fill:#eee;}#mermaid-svg-9kPj39AY4a0dpYlk text.actor > tspan{fill:#333;stroke:none;}#mermaid-svg-9kPj39AY4a0dpYlk .actor-line{stroke:#666;}#mermaid-svg-9kPj39AY4a0dpYlk .messageLine0{stroke-width:1.5;stroke-dasharray:none;stroke:#333;}#mermaid-svg-9kPj39AY4a0dpYlk .messageLine1{stroke-width:1.5;stroke-dasharray:2,2;stroke:#333;}#mermaid-svg-9kPj39AY4a0dpYlk #arrowhead path{fill:#333;stroke:#333;}#mermaid-svg-9kPj39AY4a0dpYlk .sequenceNumber{fill:white;}#mermaid-svg-9kPj39AY4a0dpYlk #sequencenumber{fill:#333;}#mermaid-svg-9kPj39AY4a0dpYlk #crosshead path{fill:#333;stroke:#333;}#mermaid-svg-9kPj39AY4a0dpYlk .messageText{fill:#333;stroke:#333;}#mermaid-svg-9kPj39AY4a0dpYlk .labelBox{stroke:hsl(0,0%,83%);fill:#eee;}#mermaid-svg-9kPj39AY4a0dpYlk .labelText,#mermaid-svg-9kPj39AY4a0dpYlk .labelText > tspan{fill:#333;stroke:none;}#mermaid-svg-9kPj39AY4a0dpYlk .loopText,#mermaid-svg-9kPj39AY4a0dpYlk .loopText > tspan{fill:#333;stroke:none;}#mermaid-svg-9kPj39AY4a0dpYlk .loopLine{stroke-width:2px;stroke-dasharray:2,2;stroke:hsl(0,0%,83%);fill:hsl(0,0%,83%);}#mermaid-svg-9kPj39AY4a0dpYlk .note{stroke:hsl(60,100%,23.3333333333%);fill:#ffa;}#mermaid-svg-9kPj39AY4a0dpYlk .noteText,#mermaid-svg-9kPj39AY4a0dpYlk .noteText > tspan{fill:#333;stroke:none;}#mermaid-svg-9kPj39AY4a0dpYlk .activation0{fill:#f4f4f4;stroke:#666;}#mermaid-svg-9kPj39AY4a0dpYlk .activation1{fill:#f4f4f4;stroke:#666;}#mermaid-svg-9kPj39AY4a0dpYlk .activation2{fill:#f4f4f4;stroke:#666;}#mermaid-svg-9kPj39AY4a0dpYlk:root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}#mermaid-svg-9kPj39AY4a0dpYlk sequence{fill:apa;}</style><g></g><g><line id="actor6910" x1="75" y1="5" x2="75" y2="390" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="0" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="75" y="32.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="75" dy="0">User</tspan></text></g><g><line id="actor6911" x1="589" y1="5" x2="589" y2="390" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="514" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="589" y="32.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="589" dy="0">WebClient</tspan></text></g><g><line id="actor6912" x1="1364" y1="5" x2="1364" y2="390" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="1289" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="1364" y="32.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="1364" dy="0">Metdata</tspan></text></g><g><line id="actor6913" x1="1585" y1="5" x2="1585" y2="390" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="1489" y="0" fill="#eaeaea" stroke="#666" width="192" height="65" rx="3" ry="3" class="actor"></rect><text x="1585" y="32.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="1585" dy="0">ClientActionValidationService</tspan></text></g><defs><marker id="arrowhead" refX="9" refY="5" markerUnits="userSpaceOnUse" markerWidth="12" markerHeight="12" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z"></path></marker></defs><defs><marker id="crosshead" markerWidth="15" markerHeight="8" orient="auto" refX="16" refY="4"><path fill="black" stroke="#000000" stroke-width="1px" d="M 9,2 V 6 L16,4 Z" style="stroke-dasharray: 0px, 0px;"></path><path fill="none" stroke="#000000" stroke-width="1px" d="M 0,1 L 6,7 M 6,1 L 0,7" style="stroke-dasharray: 0px, 0px;"></path></marker></defs><defs><marker id="filled-head" refX="18" refY="7" markerWidth="20" markerHeight="28" orient="auto"><path d="M 18,7 L9,13 L14,7 L9,1 Z"></path></marker></defs><defs><marker id="sequencenumber" refX="15" refY="15" markerWidth="60" markerHeight="40" orient="auto"><circle cx="15" cy="15" r="6"></circle></marker></defs><text x="332" y="80" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family: &quot;trebuchet ms&quot;, verdana, arial, sans-serif; font-size: 16px; font-weight: 400;">Пользователь выбирает документ в списке</text><line x1="75" y1="113" x2="589" y2="113" class="messageLine0" stroke-width="2" stroke="none" marker-end="url(#arrowhead)" style="fill: none;"></line><text x="977" y="128" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family: &quot;trebuchet ms&quot;, verdana, arial, sans-serif; font-size: 16px; font-weight: 400;">Получение списка клиентских валидаторов из локального кеша веб-клиента (загружен ранее)</text><line x1="589" y1="161" x2="1364" y2="161" class="messageLine0" stroke-width="2" stroke="none" marker-end="url(#arrowhead)" style="fill: none;"></line><text x="1087" y="176" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family: &quot;trebuchet ms&quot;, verdana, arial, sans-serif; font-size: 16px; font-weight: 400;">Выполнить клиентские валидаторы</text><line x1="589" y1="209" x2="1585" y2="209" class="messageLine0" stroke-width="2" stroke="none" marker-end="url(#arrowhead)" style="fill: none;"></line><text x="1087" y="224" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family: &quot;trebuchet ms&quot;, verdana, arial, sans-serif; font-size: 16px; font-weight: 400;">список отключенных действий</text><line x1="1585" y1="257" x2="589" y2="257" class="messageLine0" stroke-width="2" stroke="none" marker-end="url(#arrowhead)" style="fill: none;"></line><text x="332" y="272" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family: &quot;trebuchet ms&quot;, verdana, arial, sans-serif; font-size: 16px; font-weight: 400;">актуализировать список доступных пользователю действий</text><line x1="589" y1="305" x2="75" y2="305" class="messageLine0" stroke-width="2" stroke="none" marker-end="url(#arrowhead)" style="fill: none;"></line><g><rect x="0" y="325" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="75" y="357.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="75" dy="0">User</tspan></text></g><g><rect x="514" y="325" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="589" y="357.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="589" dy="0">WebClient</tspan></text></g><g><rect x="1289" y="325" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="1364" y="357.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="1364" dy="0">Metdata</tspan></text></g><g><rect x="1489" y="325" fill="#eaeaea" stroke="#666" width="192" height="65" rx="3" ry="3" class="actor"></rect><text x="1585" y="357.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="1585" dy="0">ClientActionValidationService</tspan></text></g></svg></pre>
<h2 id="диаграмма-обработки-вызова-действия-пользователем">Диаграмма обработки вызова действия пользователем</h2>
<pre class=" language-mermaid"><svg id="mermaid-svg-kNcGNy8uJcg6oaiR" width="100%" xmlns="http://www.w3.org/2000/svg" height="1073" style="max-width: 3564px;" viewBox="-50 -10 3564 1073"><style>#mermaid-svg-kNcGNy8uJcg6oaiR{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#000000;}#mermaid-svg-kNcGNy8uJcg6oaiR .error-icon{fill:#552222;}#mermaid-svg-kNcGNy8uJcg6oaiR .error-text{fill:#552222;stroke:#552222;}#mermaid-svg-kNcGNy8uJcg6oaiR .edge-thickness-normal{stroke-width:2px;}#mermaid-svg-kNcGNy8uJcg6oaiR .edge-thickness-thick{stroke-width:3.5px;}#mermaid-svg-kNcGNy8uJcg6oaiR .edge-pattern-solid{stroke-dasharray:0;}#mermaid-svg-kNcGNy8uJcg6oaiR .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-svg-kNcGNy8uJcg6oaiR .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-svg-kNcGNy8uJcg6oaiR .marker{fill:#666;stroke:#666;}#mermaid-svg-kNcGNy8uJcg6oaiR .marker.cross{stroke:#666;}#mermaid-svg-kNcGNy8uJcg6oaiR svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-svg-kNcGNy8uJcg6oaiR .actor{stroke:hsl(0,0%,83%);fill:#eee;}#mermaid-svg-kNcGNy8uJcg6oaiR text.actor > tspan{fill:#333;stroke:none;}#mermaid-svg-kNcGNy8uJcg6oaiR .actor-line{stroke:#666;}#mermaid-svg-kNcGNy8uJcg6oaiR .messageLine0{stroke-width:1.5;stroke-dasharray:none;stroke:#333;}#mermaid-svg-kNcGNy8uJcg6oaiR .messageLine1{stroke-width:1.5;stroke-dasharray:2,2;stroke:#333;}#mermaid-svg-kNcGNy8uJcg6oaiR #arrowhead path{fill:#333;stroke:#333;}#mermaid-svg-kNcGNy8uJcg6oaiR .sequenceNumber{fill:white;}#mermaid-svg-kNcGNy8uJcg6oaiR #sequencenumber{fill:#333;}#mermaid-svg-kNcGNy8uJcg6oaiR #crosshead path{fill:#333;stroke:#333;}#mermaid-svg-kNcGNy8uJcg6oaiR .messageText{fill:#333;stroke:#333;}#mermaid-svg-kNcGNy8uJcg6oaiR .labelBox{stroke:hsl(0,0%,83%);fill:#eee;}#mermaid-svg-kNcGNy8uJcg6oaiR .labelText,#mermaid-svg-kNcGNy8uJcg6oaiR .labelText > tspan{fill:#333;stroke:none;}#mermaid-svg-kNcGNy8uJcg6oaiR .loopText,#mermaid-svg-kNcGNy8uJcg6oaiR .loopText > tspan{fill:#333;stroke:none;}#mermaid-svg-kNcGNy8uJcg6oaiR .loopLine{stroke-width:2px;stroke-dasharray:2,2;stroke:hsl(0,0%,83%);fill:hsl(0,0%,83%);}#mermaid-svg-kNcGNy8uJcg6oaiR .note{stroke:hsl(60,100%,23.3333333333%);fill:#ffa;}#mermaid-svg-kNcGNy8uJcg6oaiR .noteText,#mermaid-svg-kNcGNy8uJcg6oaiR .noteText > tspan{fill:#333;stroke:none;}#mermaid-svg-kNcGNy8uJcg6oaiR .activation0{fill:#f4f4f4;stroke:#666;}#mermaid-svg-kNcGNy8uJcg6oaiR .activation1{fill:#f4f4f4;stroke:#666;}#mermaid-svg-kNcGNy8uJcg6oaiR .activation2{fill:#f4f4f4;stroke:#666;}#mermaid-svg-kNcGNy8uJcg6oaiR:root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}#mermaid-svg-kNcGNy8uJcg6oaiR sequence{fill:apa;}</style><g></g><g><line id="actor6914" x1="75" y1="5" x2="75" y2="1062" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="0" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="75" y="32.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="75" dy="0">User</tspan></text></g><g><line id="actor6915" x1="493" y1="5" x2="493" y2="1062" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="418" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="493" y="32.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="493" dy="0">WebClient</tspan></text></g><g><line id="actor6916" x1="920" y1="5" x2="920" y2="1062" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="845" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="920" y="32.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="920" dy="0">Metadata</tspan></text></g><g><line id="actor6917" x1="1154.5" y1="5" x2="1154.5" y2="1062" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="1045" y="0" fill="#eaeaea" stroke="#666" width="219" height="65" rx="3" ry="3" class="actor"></rect><text x="1154.5" y="32.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="1154.5" dy="0">Библиотека клиентских действий</tspan></text></g><g><line id="actor6918" x1="1389" y1="5" x2="1389" y2="1062" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="1314" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="1389" y="32.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="1389" dy="0">LcAction</tspan></text></g><g><line id="actor6919" x1="2064" y1="5" x2="2064" y2="1062" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="1989" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="2064" y="32.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="2064" dy="0">Gateway</tspan></text></g><g><line id="actor6920" x1="2463" y1="5" x2="2463" y2="1062" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="2388" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="2463" y="32.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="2463" dy="0">SecurityServer</tspan></text></g><g><line id="actor6921" x1="2672" y1="5" x2="2672" y2="1062" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="2588" y="0" fill="#eaeaea" stroke="#666" width="168" height="65" rx="3" ry="3" class="actor"></rect><text x="2672" y="32.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="2672" dy="0">REST Controller mapping</tspan></text></g><g><line id="actor6922" x1="2910" y1="5" x2="2910" y2="1062" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="2806" y="0" fill="#eaeaea" stroke="#666" width="208" height="65" rx="3" ry="3" class="actor"></rect><text x="2910" y="32.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="2910" dy="0">Сервис обработки запроса v1/lc</tspan></text></g><g><line id="actor6923" x1="3189" y1="5" x2="3189" y2="1062" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="3114" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="3189" y="32.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="3189" dy="0">Роутер запросов</tspan></text></g><g><line id="actor6924" x1="3389" y1="5" x2="3389" y2="1062" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="3314" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="3389" y="32.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="3389" dy="0">GRPC LC</tspan></text></g><defs><marker id="arrowhead" refX="9" refY="5" markerUnits="userSpaceOnUse" markerWidth="12" markerHeight="12" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z"></path></marker></defs><defs><marker id="crosshead" markerWidth="15" markerHeight="8" orient="auto" refX="16" refY="4"><path fill="black" stroke="#000000" stroke-width="1px" d="M 9,2 V 6 L16,4 Z" style="stroke-dasharray: 0px, 0px;"></path><path fill="none" stroke="#000000" stroke-width="1px" d="M 0,1 L 6,7 M 6,1 L 0,7" style="stroke-dasharray: 0px, 0px;"></path></marker></defs><defs><marker id="filled-head" refX="18" refY="7" markerWidth="20" markerHeight="28" orient="auto"><path d="M 18,7 L9,13 L14,7 L9,1 Z"></path></marker></defs><defs><marker id="sequencenumber" refX="15" refY="15" markerWidth="60" markerHeight="40" orient="auto"><circle cx="15" cy="15" r="6"></circle></marker></defs><text x="284" y="80" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family: &quot;trebuchet ms&quot;, verdana, arial, sans-serif; font-size: 16px; font-weight: 400;">Пользователь нажимает на кнопку "Утвердить"</text><line x1="75" y1="113" x2="493" y2="113" class="messageLine0" stroke-width="2" stroke="none" marker-end="url(#arrowhead)" style="fill: none;"></line><text x="707" y="128" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family: &quot;trebuchet ms&quot;, verdana, arial, sans-serif; font-size: 16px; font-weight: 400;">Получить метаданные действия кнопки</text><line x1="493" y1="161" x2="920" y2="161" class="messageLine0" stroke-width="2" stroke="none" marker-end="url(#arrowhead)" style="fill: none;"></line><text x="707" y="176" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family: &quot;trebuchet ms&quot;, verdana, arial, sans-serif; font-size: 16px; font-weight: 400;">идентификатор действия v1/lc/approve$manual</text><line x1="920" y1="209" x2="493" y2="209" class="messageLine0" stroke-width="2" stroke="none" marker-end="url(#arrowhead)" style="fill: none;"></line><text x="824" y="224" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family: &quot;trebuchet ms&quot;, verdana, arial, sans-serif; font-size: 16px; font-weight: 400;">поиск действия v1/lc/approve$manual</text><line x1="493" y1="257" x2="1154.5" y2="257" class="messageLine0" stroke-width="2" stroke="none" marker-end="url(#arrowhead)" style="fill: none;"></line><text x="824" y="272" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family: &quot;trebuchet ms&quot;, verdana, arial, sans-serif; font-size: 16px; font-weight: 400;">поиск действия v1/lc/approve</text><line x1="493" y1="305" x2="1154.5" y2="305" class="messageLine0" stroke-width="2" stroke="none" marker-end="url(#arrowhead)" style="fill: none;"></line><text x="824" y="320" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family: &quot;trebuchet ms&quot;, verdana, arial, sans-serif; font-size: 16px; font-weight: 400;">поиск действия v1/lc/</text><line x1="493" y1="353" x2="1154.5" y2="353" class="messageLine0" stroke-width="2" stroke="none" marker-end="url(#arrowhead)" style="fill: none;"></line><text x="824" y="368" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family: &quot;trebuchet ms&quot;, verdana, arial, sans-serif; font-size: 16px; font-weight: 400;">клиентская функция реализации действия (LcAction)</text><line x1="1154.5" y1="401" x2="493" y2="401" class="messageLine0" stroke-width="2" stroke="none" marker-end="url(#arrowhead)" style="fill: none;"></line><text x="941" y="416" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family: &quot;trebuchet ms&quot;, verdana, arial, sans-serif; font-size: 16px; font-weight: 400;">вызов действия с передачей ему в качестве аргумента v1/lc/approve$manual</text><line x1="493" y1="449" x2="1389" y2="449" class="messageLine0" stroke-width="2" stroke="none" marker-end="url(#arrowhead)" style="fill: none;"></line><text x="1727" y="464" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family: &quot;trebuchet ms&quot;, verdana, arial, sans-serif; font-size: 16px; font-weight: 400;">Формирование запроса и вызов REST-сервиса /api/actions/v1/lc/approve$manual</text><line x1="1389" y1="497" x2="2064" y2="497" class="messageLine0" stroke-width="2" stroke="none" marker-end="url(#arrowhead)" style="fill: none;"></line><text x="2264" y="512" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family: &quot;trebuchet ms&quot;, verdana, arial, sans-serif; font-size: 16px; font-weight: 400;">Проверка доступа пользователю к операции</text><line x1="2064" y1="545" x2="2463" y2="545" class="messageLine0" stroke-width="2" stroke="none" style="fill: none;"></line><text x="2368" y="560" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family: &quot;trebuchet ms&quot;, verdana, arial, sans-serif; font-size: 16px; font-weight: 400;">подбор подходящего обработчика (т.е. обработчика для /api/actions/v1/lc/{lcName}/{variant}</text><line x1="2064" y1="593" x2="2672" y2="593" class="messageLine0" stroke-width="2" stroke="none" marker-end="url(#arrowhead)" style="fill: none;"></line><text x="2368" y="608" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family: &quot;trebuchet ms&quot;, verdana, arial, sans-serif; font-size: 16px; font-weight: 400;">Сервис обработки запроса v1/lc</text><line x1="2672" y1="641" x2="2064" y2="641" class="messageLine0" stroke-width="2" stroke="none" marker-end="url(#arrowhead)" style="fill: none;"></line><text x="2487" y="656" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family: &quot;trebuchet ms&quot;, verdana, arial, sans-serif; font-size: 16px; font-weight: 400;">вызвать действие</text><line x1="2064" y1="689" x2="2910" y2="689" class="messageLine0" stroke-width="2" stroke="none" style="fill: none;"></line><text x="3050" y="704" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family: &quot;trebuchet ms&quot;, verdana, arial, sans-serif; font-size: 16px; font-weight: 400;">определить целевой сервер</text><line x1="2910" y1="737" x2="3189" y2="737" class="messageLine0" stroke-width="2" stroke="none" marker-end="url(#arrowhead)" style="fill: none;"></line><text x="3050" y="752" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family: &quot;trebuchet ms&quot;, verdana, arial, sans-serif; font-size: 16px; font-weight: 400;">ed-01-server</text><line x1="3189" y1="785" x2="2910" y2="785" class="messageLine0" stroke-width="2" stroke="none" marker-end="url(#arrowhead)" style="fill: none;"></line><text x="3150" y="800" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family: &quot;trebuchet ms&quot;, verdana, arial, sans-serif; font-size: 16px; font-weight: 400;">вызвать жц approve, передать доп-аргумент manual</text><line x1="2910" y1="833" x2="3389" y2="833" class="messageLine0" stroke-width="2" stroke="none" marker-end="url(#arrowhead)" style="fill: none;"></line><text x="3150" y="848" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family: &quot;trebuchet ms&quot;, verdana, arial, sans-serif; font-size: 16px; font-weight: 400;">результат обработки</text><line x1="3389" y1="881" x2="2910" y2="881" class="messageLine0" stroke-width="2" stroke="none" marker-end="url(#arrowhead)" style="fill: none;"></line><text x="1702" y="896" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family: &quot;trebuchet ms&quot;, verdana, arial, sans-serif; font-size: 16px; font-weight: 400;">результат</text><line x1="2910" y1="929" x2="493" y2="929" class="messageLine0" stroke-width="2" stroke="none" style="fill: none;"></line><text x="284" y="944" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family: &quot;trebuchet ms&quot;, verdana, arial, sans-serif; font-size: 16px; font-weight: 400;">Отображение результата</text><line x1="493" y1="977" x2="75" y2="977" class="messageLine0" stroke-width="2" stroke="none" style="fill: none;"></line><g><rect x="0" y="997" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="75" y="1029.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="75" dy="0">User</tspan></text></g><g><rect x="418" y="997" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="493" y="1029.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="493" dy="0">WebClient</tspan></text></g><g><rect x="845" y="997" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="920" y="1029.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="920" dy="0">Metadata</tspan></text></g><g><rect x="1045" y="997" fill="#eaeaea" stroke="#666" width="219" height="65" rx="3" ry="3" class="actor"></rect><text x="1154.5" y="1029.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="1154.5" dy="0">Библиотека клиентских действий</tspan></text></g><g><rect x="1314" y="997" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="1389" y="1029.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="1389" dy="0">LcAction</tspan></text></g><g><rect x="1989" y="997" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="2064" y="1029.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="2064" dy="0">Gateway</tspan></text></g><g><rect x="2388" y="997" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="2463" y="1029.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="2463" dy="0">SecurityServer</tspan></text></g><g><rect x="2588" y="997" fill="#eaeaea" stroke="#666" width="168" height="65" rx="3" ry="3" class="actor"></rect><text x="2672" y="1029.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="2672" dy="0">REST Controller mapping</tspan></text></g><g><rect x="2806" y="997" fill="#eaeaea" stroke="#666" width="208" height="65" rx="3" ry="3" class="actor"></rect><text x="2910" y="1029.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="2910" dy="0">Сервис обработки запроса v1/lc</tspan></text></g><g><rect x="3114" y="997" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="3189" y="1029.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="3189" dy="0">Роутер запросов</tspan></text></g><g><rect x="3314" y="997" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="3389" y="1029.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="3389" dy="0">GRPC LC</tspan></text></g></svg></pre>
<h2 id="возможные-действия-группы">Возможные действия, группы:</h2>
<ul>
<li>v1/lc/имя_действия_ЖЦ (эктора) - выполняет действие ЖЦ, заданное последним компонентом пути</li>
<li>v1/sign/sign - подписание документа</li>
<li>v1/sign/verify - проверка подписи документа</li>
</ul>
<h2 id="концепция-действия-по-работе-с-отчетами">Концепция действия по работе с отчетами</h2>
<p>Тут фиксирую видение как бы могло быть реализовано действие по формированию печатных форм. В условиях отсутствия детализации бизнес-составляющей задачи делаю следующие допущения:</p>
<ul>
<li>точное поведение действия (и будет ли оно частным для каждого отчета в отдельности или общим для неск отчетов) должно быть предоставлено БА</li>
<li>далее предполагаю простой сценарий при котором пользователю выводится диалог с вводами каких-то параметров</li>
<li>заполненые данные передаются на сервер, где вызывается обработчик формирования отчета</li>
<li>в ответ приходит файл отчета</li>
</ul>
<p>Возможное описание действия (далее демнострация концепции а не спецификация формата описания):</p>
<pre class=" language-xml"><code class="prism  language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>v1/reports/incomeDocReport<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>client-validators</span><span class="token punctuation">&gt;</span></span>
	  <span class="token comment">&lt;!-- Включаем действие если не выбран никакой документ --&gt;</span>
	  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>validator</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>not-selected<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>client-validators</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>client-params</span><span class="token punctuation">&gt;</span></span>
	  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>form-template<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
	  <span class="token comment">&lt;!-- указываем где взять json для этой формы. Фронт из этого параметра сделает URL вида /static/forms/common/report_two_fields.json --&gt;</span>
	     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">f:</span>string</span><span class="token punctuation">&gt;</span></span>common/report_two_fields<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">f:</span>string</span><span class="token punctuation">&gt;</span></span>
	  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>client-params</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>action</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<p>на клиенте реализован обработчик для группы действий v1/reports</p>
<pre class=" language-js"><code class="prism  language-js">val allActions <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">"v1/reports"</span> <span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">.</span><span class="token punctuation">}</span> <span class="token punctuation">}</span>

fun <span class="token function">lookupAction</span><span class="token punctuation">(</span>acionId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">//разбить строку v1/reports/incomdeDocReport на части, и поискать наличие обработчика.</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>x <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">"v1/reports/incomeDocReport"</span><span class="token punctuation">,</span> <span class="token string">"v1/reports"</span><span class="token punctuation">,</span> <span class="token string">"v1"</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
	   <span class="token keyword">if</span> x <span class="token keyword">in</span> allActions <span class="token keyword">return</span> allActions<span class="token punctuation">[</span>x<span class="token punctuation">]</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>функция, которая зарегистрирован под ключом v1/reports:</p>
<ol>
<li>Скачивает дескриптор формы, переданный параметром form-template</li>
<li>Отображает форму клиенту</li>
<li>Получает введенные данные и формирует JSON объект</li>
<li>Осуществляет вызов REST POST /api/actions/v1/reports$incomeDocReport и передает JSON  объект в виде тела запрос</li>
</ol>
<p>На стороне gateway реализован фильтр вида</p>
<pre class=" language-kotlin"><code class="prism  language-kotlin"><span class="token comment">//обрабатыем все вызовы на /api/actions, определяем вызываемый action, спрашиваем у СБ можно ли</span>
<span class="token function">route</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token string">"/api/actions/"</span><span class="token punctuation">)</span>
	<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
		<span class="token keyword">val</span> actionId <span class="token operator">=</span> request
			<span class="token punctuation">.</span><span class="token function">removeStart</span><span class="token punctuation">(</span><span class="token string">"/api/actions/"</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">substringBefore</span><span class="token punctuation">(</span><span class="token string">"$"</span><span class="token punctuation">)</span>
		<span class="token function">checkUserActionPermision</span><span class="token punctuation">(</span>actionId<span class="token punctuation">,</span> userId<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
</code></pre>
<p>и обработчик генерации отчетов вида</p>
<pre class=" language-kotlin"><code class="prism  language-kotlin"><span class="token annotation builtin">@PostMapping</span><span class="token punctuation">(</span>path <span class="token operator">=</span> <span class="token string">"/api/actions/v1/reports/{reportId}"</span><span class="token punctuation">,</span> consumes <span class="token operator">=</span> <span class="token string">"application/json"</span><span class="token punctuation">)</span>
<span class="token keyword">fun</span> <span class="token function">generateReport</span><span class="token punctuation">(</span><span class="token annotation builtin">@PathVariable</span> reportId<span class="token operator">:</span> String<span class="token punctuation">,</span> <span class="token annotation builtin">@Body</span> payload<span class="token operator">:</span> ReportParams<span class="token punctuation">)</span> <span class="token operator">:</span> ReponseEntity <span class="token punctuation">{</span>
	<span class="token keyword">return</span> applicationContext
		<span class="token punctuation">.</span>getBean<span class="token operator">&lt;</span>ReportGenerator<span class="token operator">&gt;</span><span class="token punctuation">(</span>reportId<span class="token punctuation">)</span>
		<span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>

